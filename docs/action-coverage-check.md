# Action Coverage Check

A tool for automatic verification of 100% test coverage for all Action classes.

## Overview

Action Coverage Check is a Symfony Console command that verifies all classes implementing the `ArchAction` interface have 100% code coverage. The tool is integrated into the CI/CD pipeline and prevents merging code with insufficient coverage.

## Usage

### Basic Usage

```bash
php bin/arch-coverage examples/Actions
```

### With Custom Coverage File

```bash
php bin/arch-coverage examples/Actions --coverage-file=custom-coverage.xml
```

### Via Composer Script

```bash
composer test:action-coverage
```

## How It Works

1. **Action Class Detection**: The tool scans the specified directory for PHP classes implementing the `ArchAction` interface
2. **Coverage Analysis**: Loads the coverage.xml file (Clover format) generated by PEST/PHPUnit
3. **Coverage Verification**: Checks each detected Action class for 100% coverage
4. **Reporting**: Outputs a list of classes with insufficient coverage including percentages

## Detection Criteria

A class is considered an Action if:
- Contains `implements ArchAction` in the code
- Is not located in `/Command/` or `/Pipes/` directories

## Output

### Successful Result
```
Checking Action Classes Coverage
================================

 [INFO] Found 19 Action class(es)

 [OK] All Action classes have 100% code coverage!
```

### Failed Result
```
Checking Action Classes Coverage
================================

 [INFO] Found 19 Action class(es)

 [ERROR] The following Action classes have less than 100% coverage:

  - /path/to/GetUser.php: 85.50%
  - /path/to/CreateUser.php: 92.30%
```

## GitHub Actions Integration

The tool runs automatically as part of PR checks:

```yaml
action-coverage:
  name: "ðŸŽ¯ Action Coverage (PHP 8.4)"
  runs-on: ubuntu-latest
  steps:
    - name: Check Action classes coverage
      run: bin/arch-coverage examples/Actions
```

The job fails if any Action class has less than 100% coverage.

## Configuration

### Composer Script

In `composer.json`:
```json
{
  "scripts": {
    "test:action-coverage": [
      "echo \"ðŸŽ¯ Checking Action classes coverage...\"",
      "@test:coverage",
      "bin/arch-coverage examples/Actions"
    ]
  }
}
```

### Coverage File

The default coverage file path is `coverage.xml` in the project root. This can be changed using the `--coverage-file` option.

## Parameters

| Parameter | Type | Description | Default |
|-----------|------|-------------|---------|
| `source` | argument | Path to directory containing Action classes | - |
| `--coverage-file`, `-c` | option | Path to coverage XML file | `coverage.xml` |

## Examples

### Check Examples Directory
```bash
bin/arch-coverage examples/Actions
```

### Check Application Directory
```bash
bin/arch-coverage app/Actions --coverage-file=build/coverage.xml
```

### Check Multiple Directories Sequentially
```bash
bin/arch-coverage app/Actions && bin/arch-coverage modules/*/Actions
```

## Troubleshooting

### "Coverage file not found"
- Make sure you run tests with coverage first: `composer test:coverage`
- Verify the coverage file path using `--coverage-file`

### "No Action classes found"
- Verify that classes implement the `ArchAction` interface
- Ensure the directory path is correct
- Action classes must be in `.php` files

### False Positive Results
- Pipe classes (implementing `BuilderPipe`) are automatically excluded
- Command classes are automatically excluded

## Best Practices

1. **Run before every commit**: `composer test:action-coverage`
2. **Integrate into pre-commit hook**: Prevent commits with insufficient coverage
3. **Use in CI/CD**: Automatic verification in pull requests
4. **Document exceptions**: If a class cannot have 100% coverage, document why

## Example Workflow

```bash
# 1. Create a new Action class
class GetUser implements ArchAction { ... }

# 2. Write tests
test('get user action works', function() { ... });

# 3. Run coverage check
composer test:action-coverage

# 4. If coverage < 100%, add more tests
# 5. Repeat step 3
```

## Related Documentation

- [ArchAction Interface](../src/Action/ArchAction.php)
- [DataBuilder](./DataBuilder.md)
- [DataValidator](./validation.md)
- [Testing Guide](../tests/README.md)
